<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>日語 50 音練習程式</title>
    <style>
        :root { --primary: #3b82f6; --success: #52a447; --bg: #f8f9fa; --gray: #e2e8f0; }
        body { background-color: var(--bg); font-family: sans-serif; display: flex; justify-content: center; padding: 20px; margin: 0; }
        .card { background: white; width: 100%; max-width: 550px; padding: 30px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.08); text-align: center; }
        .hidden { display: none !important; }
        
        .settings-box { border: 2px solid #f0f0f0; border-radius: 15px; padding: 20px; margin-bottom: 20px; background: #fff; }
        .actions-box { background: #f0f7ff; border-radius: 15px; padding: 20px; border: 1px solid #dbeafe; }

        .title { font-size: 1.8rem; margin-bottom: 20px; color: #333; font-weight: bold; }
        .section-label { text-align: left; font-size: 0.9rem; color: #666; margin: 10px 0 8px 5px; font-weight: bold; }
        
        .btn-group { display: flex; justify-content: center; gap: 8px; margin-bottom: 12px; flex-wrap: wrap; }
        .toggle-btn { padding: 12px 18px; border-radius: 10px; border: none; background: var(--primary); color: white; cursor: pointer; font-weight: bold; min-width: 95px; }
        .toggle-btn.active { background: var(--success); }
        .toggle-btn.disabled { background: #ccc; opacity: 0.5; pointer-events: none; }
        
        input.input-box { width: 100%; box-sizing: border-box; padding: 15px; border: 2px solid #eee; border-radius: 12px; font-size: 1.1rem; outline: none; margin-bottom: 10px; }

        .kana-grid-container { display: grid; grid-template-columns: repeat(5, 1fr); gap: 6px; margin-top: 20px; }
        .kana-cell { padding: 10px 2px; border: 1px solid #eee; background: white; border-radius: 8px; min-height: 55px; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .kana-cell.empty { background: #fafafa; border: 1px dashed #ddd; }
        .k-char { font-size: 1.3rem; font-weight: bold; }
        .k-rom { font-size: 0.75rem; color: #888; }

        .question-display { font-size: 4.5rem; margin: 25px 0; font-weight: bold; color: #333; }
        .answer-preview { font-size: 2.2rem; border-bottom: 4px solid var(--primary); min-width: 160px; height: 55px; margin-bottom: 25px; display: inline-block; }
        .numpad { display: grid; gap: 10px; position: relative; width: 100%; }
        .key { background: #eee; border: none; padding: 18px 0; border-radius: 12px; font-size: 1.25rem; cursor: pointer; font-weight: bold; }
        .key.tool { background: var(--gray); font-size: 1rem; }
        #sub-menu-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.98); display: flex; justify-content: center; align-items: center; border-radius: 15px; z-index: 100; border: 2px solid var(--primary); }
        .sub-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; }
        .sub-key { width: 65px; height: 65px; background: var(--primary); color: white; border: none; border-radius: 50%; font-size: 1.3rem; cursor: pointer; font-weight: bold; }
        
.main-btn { 
            background: var(--primary); 
            color: white; 
            border: none; 
            border-radius: 12px; 
            font-size: 1.3rem; 
            font-weight: bold; 
            cursor: pointer; 
            padding: 15px 30px; /* 恢復舒適寬度 */
            transition: 0.2s;
            box-shadow: 0 4px 10px rgba(59, 130, 246, 0.2);
        }
        .main-btn:active { transform: scale(0.98); }

        /* 測驗區專用：垂直堆疊且填滿寬度 */
        .quiz-action-btn {
            width: 100%;
            display: block;
            box-sizing: border-box;
            margin-top: 10px;
        }

        /* 選擇題選項按鈕樣式 */
        .option-btn {
            padding: 20px;
            font-size: 1.2rem;
            border-radius: 12px;
            border: 2px solid #eee;
            background: white;
            cursor: pointer;
            transition: 0.2s;
        }
        .option-btn:hover { border-color: var(--primary); background: #f0f7ff; }
        .sub-btn { background: white; border: 2px solid var(--primary); color: var(--primary); padding: 12px; border-radius: 10px; flex: 1; cursor: pointer; font-weight: bold; }

        /* 答題判斷專用 */
        .correct-text { color: var(--success) !important; }
        .wrong-text { color: red !important; }
        #check-ans-btn { background: var(--success); }

        /* 全螢幕反饋層 */
        #feedback-layer {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; justify-content: center; align-items: center;
            z-index: 1000; pointer-events: none;
        }

        @keyframes feedback-pop {
            0% { transform: scale(0.5); opacity: 0; }
            50% { transform: scale(1.2); opacity: 1; }
            100% { transform: scale(1); opacity: 0; }
        }
        .animate-feedback { animation: feedback-pop 0.8s ease-out forwards; }
    </style>
</head>
<body>

<div class="card" id="setup-screen">
    <h1 class="title">日語 50 音練習程式</h1>
    <div class="settings-box">
        <div class="section-label">測驗方向</div>
        <div class="btn-group">
            <button class="toggle-btn active" data-group="dir" id="dir-j-to-r">假翻羅</button>
            <button class="toggle-btn" data-group="dir" id="dir-r-to-j">羅翻假</button>
        </div>
        <div class="section-label">選擇題數 (空白為全部)</div>
        <input type="number" id="quiz-count" class="input-box" placeholder="全部">
        <div class="btn-group">
            <button class="toggle-btn active" data-group="mode" id="m-input">填充題</button>
            <button class="toggle-btn" data-group="mode" id="m-choice">選擇題</button>
        </div>
        <div class="btn-group">
            <button class="toggle-btn active" data-group="type" id="t-single">單一音</button>
            <button class="toggle-btn" data-group="type" id="t-word">單字詞</button>
        </div>
        <div class="section-label">範圍設定</div>
        <div class="btn-group">
            <button class="toggle-btn active" data-group="base" id="base-hira">平假名</button>
            <button class="toggle-btn" data-group="base" id="base-kata">片假名</button>
        </div>
        <div class="btn-group">
            <button class="toggle-btn" data-group="free">濁音</button>
            <button class="toggle-btn" data-group="free">半濁音</button>
            <button class="toggle-btn" data-group="free">拗音</button>
        </div>
        <div class="btn-group">
            <button class="toggle-btn disabled" data-group="word-rule">長音</button>
            <button class="toggle-btn disabled" data-group="word-rule">促音</button>
            <button class="toggle-btn disabled" data-group="word-rule">撥音</button>
        </div>
    </div>
    <div class="actions-box">
        <button class="main-btn" id="start-btn">開始測驗</button>
        <div style="display: flex; gap: 12px; margin-top: 15px;">
            <button class="sub-btn" onclick="showScreen('record-screen')">查看紀錄</button>
            <button class="sub-btn" id="view-kana-btn">50 音對照表</button>
        </div>
    </div>
</div>

<div class="card hidden" id="kana-screen">
    <h2 class="title">50 音對照表</h2>
    <div class="btn-group">
        <button class="toggle-btn active" id="table-hira-btn">平假名</button>
        <button class="toggle-btn" id="table-kata-btn">片假名</button>
    </div>
    <div id="kana-table-render" class="kana-grid-container"></div>
    <button class="main-btn" onclick="showScreen('setup-screen')" style="background:#666; margin-top: 25px;">返回設定</button>
</div>

<div class="card hidden" id="record-screen">
    <h2 class="title">測驗紀錄</h2>
    <div style="padding: 40px; color: #999;">尚無紀錄</div>
    <button class="main-btn" onclick="showScreen('setup-screen')" style="background:#666;">返回</button>
</div>

<div class="card hidden" id="quiz-screen">
    <div style="display: flex; justify-content: space-between; color: #888; font-size: 0.9rem; margin-bottom: 10px;">
        <span id="quiz-progress">題目：1 / 10</span>
        <span id="quiz-status">測驗中</span>
    </div>

<div class="question-display" id="q-text">題目</div>
    
    <div id="word-meaning" style="font-size: 1.5rem; color: #666; margin-bottom: 20px; min-height: 30px;"></div>

    <div class="answer-preview" id="ans-preview"></div>
    
    <div id="options-container" class="hidden" style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin: 20px 0;">
        </div>
    
    <button class="main-btn quiz-action-btn" id="check-ans-btn">檢查答案</button>

    <div class="numpad" id="keyboard" style="margin-top: 20px;"></div>

    <div id="sub-menu-overlay" class="hidden">
        <div class="sub-grid" id="sub-grid"></div>
    </div>

    <button class="main-btn quiz-action-btn" onclick="showResult()" style="background:#666; margin-top: 15px;">中止練習並結算</button>

    <div id="feedback-layer" class="hidden">
        <span id="feedback-icon" style="font-size: 15rem; font-weight: bold; opacity: 0.8;"></span>
    </div>
</div>
<div class="card hidden" id="result-screen">
    <h1 class="title">測驗結束</h1>
    <div style="font-size: 1.5rem; margin-bottom: 20px;">
        你的表現：<span id="result-score" style="color: var(--primary); font-weight: bold;">0 / 0</span>
    </div>
    <div id="result-stat" style="color: #666; margin-bottom: 30px; line-height: 1.6;"></div>
    <button class="main-btn" onclick="showScreen('setup-screen')" style="width: 100%;">回到主選單</button>
</div>
<script>
    // --- 統計數據變數 ---
    let stats = {
        hira: { total: 0, correct: 0, label: "平假名" },
        kata: { total: 0, correct: 0, label: "片假名" },
        daku: { total: 0, correct: 0, label: "濁音/半濁音" },
        ao:   { total: 0, correct: 0, label: "拗音" },
        word: { total: 0, correct: 0, label: "單字詞" }
    };
    let currentQuestionCategory = ""; // 記錄當前題目的類別
    // --- 單字資料庫 ---
// --- 單字資料庫 ---
    let WORD_DATA = [];
    let currentMeaning = ""; 

async function loadWordData() {
        try {
            // ▼▼▼ 在這裡修改你的檔案名稱清單 ▼▼▼
            const jsonFiles = ["japan50.json",]; 

            const allData = [];

            for (const file of jsonFiles) {
                const response = await fetch(file);
                if (!response.ok) throw new Error(`載入 ${file} 失敗`);
                
                const data = await response.json();
                if (Array.isArray(data)) {
                    allData.push(...data);
                }
            }

            WORD_DATA = allData;

            if (WORD_DATA.length === 0) {
                console.warn("題庫是空的，請檢查 JSON 檔案內容！");
            } else {
                console.log(`成功載入 ${WORD_DATA.length} 個單字`);
            }

        } catch (error) {
            console.error("載入錯誤:", error);
            alert("載入題庫失敗，請確認 JSON 檔案是否存在且格式正確。");
        }
    }
    // 程式一啟動就載入
    loadWordData();
    
    // 完整的過濾用題庫資料
    const KANA_POOL = {
        hira_base: { あ:"a",い:"i",う:"u",え:"e",お:"o",か:"ka",き:"ki",く:"ku",け:"ke",こ:"ko",さ:"sa",し:"shi",す:"su",せ:"se",そ:"so",た:"ta",ち:"chi",つ:"tsu",て:"te",と:"to",な:"ni",に:"ni",ぬ:"nu",ね:"ne",の:"no",は:"ha",ひ:"hi",ふ:"fu",へ:"he",ほ:"ho",ま:"ma",み:"mi",む:"mu",め:"me",も:"mo",や:"ya",ゆ:"yu",よ:"yo",ら:"ra",り:"ri",る:"ru",れ:"re",ろ:"ro",わ:"wa",を:"wo",ん:"n" },
        hira_daku: { が:"ga",ぎ:"gi",ぐ:"gu",げ:"ge",ご:"go",ざ:"za",じ:"ji",ず:"zu",ぜ:"ze",そ:"zo",だ:"da",ぢ:"ji",づ:"zu",で:"de",ど:"do",ば:"ba",び:"bi",ぶ:"bu",べ:"be",ぼ:"bo",ぱ:"pa",ぴ:"pi",ぷ:"pu",ぺ:"pe",ぽ:"po" },
        hira_ao: { きゃ:"kya",きゅ:"kyu",きょ:"kyo",しゃ:"sha",しゅ:"shu",しょ:"sho",ちゃ:"cha",ちゅ:"chu",ちょ:"cho",にゃ:"nya",にゅ:"nyu",にょ:"nyo",ひゃ:"hya",ひゅ:"hyu",ひょ:"hyo",みゃ:"mya",みゅ:"myu",みょ:"myo",りゃ:"rya",りゅ:"ryu",りょ:"ryo" },
        kata_base: { ア:"a",イ:"i",ウ:"u",エ:"e",オ:"o",カ:"ka",キ:"ki",ク:"ku",ケ:"ke",コ:"ko",サ:"sa",シ:"shi",ス:"su",セ:"se",ソ:"so",タ:"ta",チ:"chi",ツ:"tsu",テ:"te",ト:"to",ナ:"na",ニ:"ni",ヌ:"nu",ネ:"ne",ノ:"no",ハ:"ha",ヒ:"hi",フ:"fu",ヘ:"he",ホ:"ho",マ:"ma",ミ:"mi",ム:"mu",メ:"me",モ:"mo",ヤ:"ya",ユ:"yu",ヨ:"yo",ラ:"ra",リ:"ri",ル:"ru",レ:"re",ロ:"ro",ワ:"wa",ヲ:"wo",ン:"n" },
        kata_daku: { ガ:"ga",ギ:"gi",グ:"gu",格:"ge",ゴ:"go",ザ:"za",ジ:"ji",ズ:"zu",ゼ:"ze",ゾ:"zo",ダ:"da",ヂ:"ji",ヅ:"zu",デ:"de",ド:"do",バ:"ba",ビ:"bi",ブ:"bu",ベ:"be",ボ:"bo",パ:"pa",ピ:"pi",プ:"pu",ペ:"pe",ポ:"po" }
    };

    let currentQuestionPool = []; // 當前符合設定的題目池
    // --- 測驗狀態變數 ---
    let currentQuizIndex = 1;
    let totalQuizCount = 10;
    let correctCount = 0; // 新增：記錄答對幾題
    let remainingQuestions = []; // 新增：用來存放尚未出的題目
    
    // --- 徹底修復：使用物件陣列防止索引偏移 ---
    const KANA_KEYBOARD = {
        hira: [
            {m: "あ", s: "あいうえお"}, {m: "か", s: "かきくけこ"}, {m: "さ", s: "さしすせそ"},
            {m: "た", s: "たちつてと"}, {m: "な", s: "なにぬねの"}, {m: "は", s: "はひふへほ"},
            {m: "ま", s: "まみむめも"}, {m: "や", s: "やゆよ"}, {m: "ら", s: "らりるれろ"},
            {m: "濁/小", type: "tool"}, {m: "わ", s: "わをん"}, {m: "刪除", type: "tool"}
        ],
        kata: [
            {m: "ア", s: "アイウエオ"}, {m: "カ", s: "カキクケコ"}, {m: "サ", s: "シスセソ"},
            {m: "タ", s: "タチツテト"}, {m: "ナ", s: "ナニヌネノ"}, {m: "ハ", s: "ハヒフヘホ"},
            {m: "マ", s: "マミムメモ"}, {m: "ヤ", s: "ヤユヨ"}, {m: "ラ", s: "リルレロ"},
            {m: "濁/小", type: "tool"}, {m: "ワ", s: "ワヲン"}, {m: "刪除", type: "tool"}
        ]
    };

    // 50音對照表用資料
const KANA_MASTER = {
        hira: ["あ","い","う","え","お","か","き","く","け","こ","さ","し","す","せ","そ","た","ち","つ","て","と","な","に","ぬ","ね","の","は","ひ","ふ","へ","ほ","ま","み","む","め","も","や",null,"ゆ",null,"よ","ら","り","る","れ","ろ","わ",null,null,null,"を",null,null,null,null,"ん"],
        kata: ["ア","イ","ウ","エ","オ","カ","キ","ク","ケ","コ","サ","シ","ス","セ","ソ","タ","チ","ツ","テ","ト","ナ","ニ","ヌ","ネ","ノ","ハ","ヒ","フ","ヘ","ホ","マ","ミ","ム","メ","モ","ヤ",null,"ユ",null,"ヨ","ラ","リ","ル","レ","ロ","ワ",null,null,null,"ヲ",null,null,null,null,"ン"],
        romaji: ["a","i","u","e","o","ka","ki","ku","ke","ko","sa","shi","su","se","so","ta","chi","tsu","te","to","na","ni","nu","ne","no","ha","hi","fu","he","ho","ma","mi","mu","me","mo","ya","","yu","","yo","ra","ri","ru","re","ro","wa","","","","wo","","","","","n"],
        kb_hira: [
            {m:"あ", s:"あいうえお"}, {m:"か", s:"かきくけこ"}, {m:"さ", s:"さしすせそ"},
            {m:"た", s:"たちつてと"}, {m:"な", s:"なにぬねの"}, {m:"は", s:"はひふへほ"},
            {m:"ま", s:"まみむめも"}, {m:"や", s:"やゆよ"}, {m:"ら", s:"らりるれろ"},
            {m:"濁/小", type:"tool"}, {m:"わ", s:"わをん"}, {m:"刪除", type:"tool"}
        ],
        kb_kata: [
            {m:"ア", s:"アイウエオ"}, {m:"カ", s:"カキクケコ"}, {m:"サ", s:"シスセソ"},
            {m:"タ", s:"タチツテト"}, {m:"ナ", s:"ナニヌネノ"}, {m:"ハ", s:"ハヒフヘホ"},
            {m:"マ", s:"マミムメモ"}, {m:"ヤ", s:"ヤユヨ"}, {m:"ラ", s:"リルレロ"},
            {m:"濁/小", type:"tool"}, {m:"ワ", s:"ワヲン"}, {m:"刪除", type:"tool"}
        ]
    };

    const cycleMap = {
        'あ':'ぁ','ぁ':'あ','い':'ぃ','ぃ':'い','う':'ぅ','ぅ':'う','え':'ぇ','ぇ':'え','お':'ぉ','ぉ':'お',
        'か':'が','が':'か','き':'ぎ','ぎ':'き','く':'ぐ','ぐ':'く','け':'げ','げ':'け','こ':'ご','ご':'こ',
        'さ':'ざ','ざ':'さ','し':'じ','じ':'し','す':'ず','ず':'す','せ':'ぜ','ぜ':'せ','そ':'ぞ','ぞ':'そ',
        'た':'だ','だ':'た','ち':'ぢ','ぢ':'ち','つ':'っ','っ':'づ','づ':'つ','て':'で','で':'て','と':'ど','ど':'と',
        'は':'ば','ば':'ぱ','ぱ':'は','ひ':'び','び':'ぴ','ぴ':'ひ','ふ':'ぶ','ぶ':'ぷ','ぷ':'ふ','へ':'べ','べ':'ぺ','ぺ':'へ','ほ':'ぼ','ぼ':'ぽ','ぽ':'ほ',
        'や':'ゃ','ゃ':'や','ゆ':'ゅ','ゅ':'ゆ','よ':'ょ','ょ':'よ',
        'ア':'ァ','ァ':'ア','イ':'ィ','ィ':'イ','ウ':'ゥ','ゥ':'ウ','エ':'ェ','ェ':'エ','オ':'ォ','ォ':'オ',
        'カ':'ガ','ガ':'カ','キ':'ギ','ギ':'キ','ク':'グ','グ':'ク','ケ':'ゲ','ゲ':'け','コ':'ゴ','ゴ':'コ',
        'サ':'ザ','ザ':'サ','シ':'ジ','ジ':'シ','ス':'ズ','ズ':'ス','セ':'ゼ','ゼ':'セ','ソ':'ゾ','ゾ':'ソ',
        'タ':'ダ','ダ':'タ','チ':'ヂ','ヂ':'チ','ツ':'ッ','ッ':'ヅ','ヅ':'ツ',
        'ハ':'バ','バ':'パ','パ':'ハ','ヒ':'ビ','ビ':'ピ','ピ':'ヒ','フ':'ブ','ブ':'プ','プ':'フ','ヘ':'ベ','ベ':'ペ','ペ':'ヘ','ホ':'ボ','ボ':'ポ','ポ':'ホ',
        'ヤ':'ャ','ャ':'ヤ','ユ':'ュ','ュ':'ユ','ヨ':'ョ','ョ':'ヨ'
    };

    function showScreen(id) {
        document.querySelectorAll('.card').forEach(c => c.classList.add('hidden'));
        document.getElementById(id).classList.remove('hidden');
        // 離開測驗時清空預覽文字
        if (id === 'setup-screen') {
            document.getElementById('ans-preview').innerText = '';
        }
    }

    // 修改為接受一個參數 forceKata
    function renderKeyboard(forceKata = null) {
        const kb = document.getElementById('keyboard');
        const isJtoR = document.getElementById('dir-j-to-r').classList.contains('active');
        
        // 如果沒有指定，才去讀取首頁設定
        let isKata = forceKata !== null ? forceKata : (document.getElementById('base-kata').classList.contains('active') && !document.getElementById('base-hira').classList.contains('active'));
        
        kb.innerHTML = '';

        if (isJtoR) {
            kb.style.gridTemplateColumns = 'repeat(7, 1fr)';
            "abcdefghijklmnopqrstuvwxyz".split('').forEach(l => {
                const b = document.createElement('button'); 
                b.className = 'key'; b.innerText = l;
                b.style.fontSize = '1rem'; b.style.padding = '10px 0';
                b.onclick = () => document.getElementById('ans-preview').innerText += l;
                kb.appendChild(b);
            });
        } else {
            kb.style.gridTemplateColumns = 'repeat(3, 1fr)';
            const data = isKata ? KANA_KEYBOARD.kata : KANA_KEYBOARD.hira;
            data.forEach(item => {
                const b = document.createElement('button');
                b.className = (item.type === 'tool') ? 'key tool' : 'key';
                b.innerText = item.m;
                if (item.m === '刪除') {
                    b.onclick = () => { document.getElementById('ans-preview').innerText = document.getElementById('ans-preview').innerText.slice(0, -1); };
                } else if (item.m === '濁/小') {
                    b.onclick = () => {
                        const p = document.getElementById('ans-preview'); let t = p.innerText; if(!t) return;
                        let last = t.slice(-1); if(cycleMap[last]) p.innerText = t.slice(0, -1) + cycleMap[last];
                    };
                } else { b.onclick = () => showSub(item.s); }
                kb.appendChild(b);
            });
        }
        
        // 統一補上刪除鍵 (若是羅馬拼音模式)
        if(isJtoR) {
            const del = document.createElement('button');
            del.className = 'key tool'; del.innerText = '刪';
            del.style.gridColumn = 'span 1';
            del.onclick = () => { document.getElementById('ans-preview').innerText = document.getElementById('ans-preview').innerText.slice(0, -1); };
            kb.appendChild(del);
        }
    }

    function showSub(chars) {
        const overlay = document.getElementById('sub-menu-overlay');
        const grid = document.getElementById('sub-grid');
        grid.innerHTML = '';
        chars.split('').forEach(c => {
            const b = document.createElement('button'); 
            b.className = 'sub-key'; 
            b.innerText = c;
            b.onclick = () => { 
                document.getElementById('ans-preview').innerText += c; 
                overlay.classList.add('hidden'); 
            };
            grid.appendChild(b);
        });
        const x = document.createElement('button'); 
        x.className = 'sub-key'; 
        x.innerText = 'X'; 
        x.style.background = '#666';
        x.onclick = () => overlay.classList.add('hidden');
        grid.appendChild(x);
        overlay.classList.remove('hidden');
    }

    function renderKanaTable(type) {
        const target = document.getElementById('kana-table-render');
        target.innerHTML = '';
        KANA_MASTER[type].forEach((char, i) => {
            const cell = document.createElement('div');
            cell.className = char ? 'kana-cell' : 'kana-cell empty';
            if(char) cell.innerHTML = `<span class="k-char">${char}</span><span class="k-rom">${KANA_MASTER.romaji[i]}</span>`;
            target.appendChild(cell);
        });
    }

    document.querySelectorAll('.toggle-btn').forEach(btn => {
        btn.onclick = function() {
            const group = this.dataset.group;
            if(['dir','mode','type','base'].includes(group)) {
                const actives = this.parentElement.querySelectorAll('.active');
                if(this.classList.contains('active')) { 
                    if(actives.length > 1) this.classList.remove('active'); 
                } else { 
                    this.classList.add('active'); 
                }
            } else { 
                this.classList.toggle('active'); 
            }
            const isWordMode = document.getElementById('t-word').classList.contains('active');
            document.querySelectorAll('[data-group="word-rule"]').forEach(b => {
                if(isWordMode) b.classList.remove('disabled');
                else { b.classList.add('disabled'); b.classList.remove('active'); }
            });
        };
    });

    document.getElementById('view-kana-btn').onclick = () => { renderKanaTable('hira'); showScreen('kana-screen'); };
    document.getElementById('table-hira-btn').onclick = () => { renderKanaTable('hira'); document.getElementById('table-hira-btn').classList.add('active'); document.getElementById('table-kata-btn').classList.remove('active'); };
    document.getElementById('table-kata-btn').onclick = () => { renderKanaTable('kata'); document.getElementById('table-kata-btn').classList.add('active'); document.getElementById('table-hira-btn').classList.remove('active'); };
    document.getElementById('start-btn').onclick = () => { renderKeyboard(); showScreen('quiz-screen'); };

    // --- 答題判斷變數 ---
    let currentTargetAnswer = ""; 

    // 檢查答案函式
function checkAnswer() {
        const userAns = document.getElementById('ans-preview').innerText.trim();
        const feedbackLayer = document.getElementById('feedback-layer');
        const feedbackIcon = document.getElementById('feedback-icon');
        
        if (!userAns) return;

        feedbackLayer.classList.remove('hidden');
        
        if (userAns === currentTargetAnswer) {
            feedbackIcon.innerText = "〇";
            feedbackIcon.className = "correct-text animate-feedback";
        } else {
            feedbackIcon.innerText = "×";
            feedbackIcon.className = "wrong-text animate-feedback";
        }

        setTimeout(() => {
            feedbackLayer.classList.add('hidden');
            feedbackIcon.className = "";
            currentQuizIndex++;
            nextQuestion(); // 這裡現在可以呼叫了！
        }, 800);
    }

    // 更新介面的函式
    function updateProgressUI() {
        document.getElementById('quiz-progress').innerText = `題目：${currentQuizIndex} / ${totalQuizCount}`;
    }

    // 綁定按鈕
    document.getElementById('check-ans-btn').onclick = checkAnswer;

    // 修改開始按鈕邏輯
document.getElementById('start-btn').onclick = () => {
    // 1. 重置與設定
    stats = {
        hira: { total: 0, correct: 0, label: "平假名" },
        kata: { total: 0, correct: 0, label: "片假名" },
        daku: { total: 0, correct: 0, label: "濁音/半濁音" },
        ao:   { total: 0, correct: 0, label: "拗音" },
        word: { total: 0, correct: 0, label: "單字詞" }
    };

    const inputCount = document.getElementById('quiz-count').value;
    currentQuizIndex = 1;
    correctCount = 0;
    
    // 判斷是否為單字模式
    const isWordMode = document.getElementById('t-word').classList.contains('active');
    currentQuestionPool = [];

    if (isWordMode) {
        // --- 單字模式邏輯 ---
        if (!WORD_DATA || WORD_DATA.length === 0) { 
            alert("單字庫尚未載入，請稍後再試！"); 
            return; 
        }
        currentQuestionPool = [...WORD_DATA];
    } else {
        // --- 單一音過濾邏輯 ---
        const useHira = document.getElementById('base-hira').classList.contains('active');
        const useKata = document.getElementById('base-kata').classList.contains('active');
        
        // 穩健抓取濁音與拗音按鈕
        const freeBtns = Array.from(document.querySelectorAll('[data-group="free"]'));
        const useDaku = freeBtns.find(b => b.innerText.includes('濁音'))?.classList.contains('active') || false;
        const useAo = freeBtns.find(b => b.innerText.includes('拗音'))?.classList.contains('active') || false;

        function addToPool(obj) {
            for (let k in obj) currentQuestionPool.push({ kana: k, romaji: obj[k] });
        }

        if (useHira) addToPool(KANA_POOL.hira_base);
        if (useKata) addToPool(KANA_POOL.kata_base);
        if (useDaku) {
            if (useHira) addToPool(KANA_POOL.hira_daku);
            if (useKata) addToPool(KANA_POOL.kata_daku);
        }
        if (useAo && useHira) addToPool(KANA_POOL.hira_ao);
    }

    if (currentQuestionPool.length === 0) { alert("請至少選擇一個範圍！"); return; }

    // 2. 隨機打亂
    remainingQuestions = [...currentQuestionPool].sort(() => Math.random() - 0.5);

    // 3. 設定總題數
    const maxAvailable = remainingQuestions.length;
    totalQuizCount = inputCount ? Math.min(parseInt(inputCount), maxAvailable) : Math.min(10, maxAvailable);
    
    // 4. UI 初始化
    const isInputMode = document.getElementById('m-input').classList.contains('active');
    document.getElementById('options-container').classList.toggle('hidden', isInputMode);
    document.getElementById('ans-preview').classList.toggle('hidden', !isInputMode);
    document.getElementById('check-ans-btn').classList.toggle('hidden', !isInputMode);
    document.getElementById('keyboard').classList.toggle('hidden', !isInputMode);
    
    document.getElementById('word-meaning').classList.add('hidden');

    showScreen('quiz-screen');
    nextQuestion();
};
function nextQuestion() {
        if (currentQuizIndex > totalQuizCount) {
            showResult();
            return;
        }

        updateProgressUI();
        document.getElementById('ans-preview').innerText = "";
        document.getElementById('word-meaning').classList.add('hidden');

        const questionObj = remainingQuestions.pop(); 
        
        // --- 新增：判斷題目類別 ---
        const isWordMode = document.getElementById('t-word').classList.contains('active');
        
        if (isWordMode) {
            currentQuestionCategory = 'word';
        } else {
            // 根據題目字元判斷類別
            const k = questionObj.kana;
            if (k.length > 1 && (k.includes('ゃ') || k.includes('ゅ') || k.includes('ょ') || k.includes('ャ') || k.includes('ュ') || k.includes('ョ'))) {
                currentQuestionCategory = 'ao'; // 拗音
            } else if (k.includes('゛') || k.includes('゜') || ((k.charCodeAt(0) >= 0x3099 && k.charCodeAt(0) <= 0x309C) || "がぎぐげござじずぜぞだぢづでどばびぶべぼぱぴぷぺぽ".includes(k))) {
                currentQuestionCategory = 'daku'; // 濁音/半濁音
            } else if (/[\u30A0-\u30FF]/.test(k)) {
                currentQuestionCategory = 'kata'; // 片假名
            } else {
                currentQuestionCategory = 'hira'; // 平假名
            }
        }
        
        // 該類別出題數 +1
        if(stats[currentQuestionCategory]) {
            stats[currentQuestionCategory].total++;
        }

        // --- 以下維持原本的出題邏輯 ---
        currentMeaning = questionObj.meaning || ""; 
        const isJtoR = document.getElementById('dir-j-to-r').classList.contains('active');
        const isInputMode = document.getElementById('m-input').classList.contains('active');

        if (isJtoR) {
            document.getElementById('q-text').innerText = questionObj.kana;
            currentTargetAnswer = questionObj.romaji;
        } else {
            document.getElementById('q-text').innerText = questionObj.romaji;
            currentTargetAnswer = questionObj.kana;
        }

        const qText = document.getElementById('q-text');
        qText.style.fontSize = questionObj.kana.length > 3 ? "3rem" : "4.5rem";

        if (isInputMode) {
            const isTargetKata = /[\u30A0-\u30FF]/.test(questionObj.kana);
            renderKeyboard(isTargetKata); 
        } else {
            generateOptions(questionObj, isJtoR);
        }
    }

function checkAnswer() {
        const userAns = document.getElementById('ans-preview').innerText.trim();
        if (!userAns) return;
        
        const feedbackLayer = document.getElementById('feedback-layer');
        const feedbackIcon = document.getElementById('feedback-icon');
        const meaningDisplay = document.getElementById('word-meaning');

        feedbackLayer.classList.remove('hidden');
        
        if (currentMeaning) {
            meaningDisplay.innerText = currentMeaning;
            meaningDisplay.classList.remove('hidden');
        }

        if (userAns === currentTargetAnswer) {
            feedbackIcon.innerText = "〇";
            feedbackIcon.className = "correct-text animate-feedback";
            correctCount++;
            // --- 新增：分類答對數 +1 ---
            if (stats[currentQuestionCategory]) {
                stats[currentQuestionCategory].correct++;
            }
        } else {
            feedbackIcon.innerText = "×";
            feedbackIcon.className = "wrong-text animate-feedback";
        }

        setTimeout(() => {
            feedbackLayer.classList.add('hidden');
            feedbackIcon.className = "";
            currentQuizIndex++;
            nextQuestion();
        }, 1500); 
    }

    // 新增：顯示結算畫面
function showResult() {
        showScreen('result-screen');
        let actualTotal = currentQuizIndex - 1;
        
        // 特殊情況：如果全部做完自然結束，currentQuizIndex 會比總題數大 1
        if (currentQuizIndex > totalQuizCount) {
            actualTotal = totalQuizCount;
        } else {
            // 如果是中途中止，代表「當前這題」算在 stats 的 total 裡了，但還沒答
            // 所以要從該類別的 total 中扣除
            if (currentQuestionCategory && stats[currentQuestionCategory]) {
                if (stats[currentQuestionCategory].total > 0) {
                    stats[currentQuestionCategory].total--;
                }
            }
        }

        if (actualTotal <= 0) actualTotal = 0;

        // 2. 顯示總分
        document.getElementById('result-score').innerText = `${correctCount} / ${actualTotal}`;
        
        const percent = actualTotal > 0 ? Math.round((correctCount / actualTotal) * 100) : 0;
        let comment = percent === 100 ? "太棒了！完全正確！" : percent >= 80 ? "很厲害喔，繼續保持！" : "再接再厲，多練習幾次！";
        
        // 3. 生成詳細分析 HTML
        let statHTML = `<div style="font-size: 1.2rem; margin-bottom: 15px;">總正確率：${percent}%</div>`;
        statHTML += `<div style="text-align: left; background: #f9f9f9; padding: 15px; border-radius: 10px;">`;
        
        let hasDetail = false;
        for (let key in stats) {
            // 只顯示有「有效出題」的類別 (total > 0)
            if (stats[key].total > 0) {
                hasDetail = true;
                const catTotal = stats[key].total;
                const catCorrect = stats[key].correct;
                const catRate = Math.round((catCorrect / catTotal) * 100);
                
                const color = catRate >= 80 ? 'var(--success)' : (catRate < 50 ? 'red' : '#666');

                statHTML += `
                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px; border-bottom: 1px dashed #eee; padding-bottom: 5px;">
                        <span>${stats[key].label}</span>
                        <span style="font-weight: bold; color: ${color}">
                            ${catCorrect}/${catTotal} (${catRate}%)
                        </span>
                    </div>`;
            }
        }
        
        if (!hasDetail) {
            statHTML += `<div style="color: #999; text-align: center;">尚未作答</div>`;
        }

        statHTML += `</div><div style="margin-top: 20px; color: #555; font-weight:bold;">${comment}</div>`;
        
        document.getElementById('result-stat').innerHTML = statHTML;
    }

    function generateOptions(correctObj, isJtoR) {
        const container = document.getElementById('options-container');
        container.innerHTML = '';
        
        let options = [];
        const correctValue = isJtoR ? correctObj.romaji : correctObj.kana;
        options.push(correctValue);

        // 隨機抓 3 個錯誤選項，並確保「意義」不重複
        while (options.length < 4) {
            const randomObj = currentQuestionPool[Math.floor(Math.random() * currentQuestionPool.length)];
            const randomValue = isJtoR ? randomObj.romaji : randomObj.kana;
            
            // 檢查是否重複，或是否為同一發音的不同寫法
            const isDuplicate发音 = options.some(opt => {
                // 如果是羅翻假模式，要額外檢查羅馬拼音是否跟現有選項的羅馬拼音撞到
                return opt === randomValue;
            });

            if (!isDuplicate发音) {
                options.push(randomValue);
            }
        }

        options.sort(() => Math.random() - 0.5);
        options.forEach(opt => {
            const btn = document.createElement('button');
            btn.className = 'option-btn';
            btn.innerText = opt;
            btn.onclick = () => {
                document.getElementById('ans-preview').innerText = opt;
                checkAnswer();
            };
            container.appendChild(btn);
        });
    }
    // 實作選擇題按鈕生成
    function renderMultipleChoice() {
        const container = document.getElementById('options-container');
        container.innerHTML = '';
        
        // 模擬選項 (未來會從題庫抓)
        const dummyOptions = ["a", "i", "u", "e"]; 
        
        dummyOptions.forEach(opt => {
            const btn = document.createElement('button');
            btn.className = 'option-btn';
            btn.innerText = opt;
            btn.onclick = () => {
                // 直接判斷對錯 (選擇題點了就判定)
                document.getElementById('ans-preview').innerText = opt;
                checkAnswer();
            };
            container.appendChild(btn);
        });
    }
</script>
</body>
</html>